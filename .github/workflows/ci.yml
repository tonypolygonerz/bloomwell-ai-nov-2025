name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  quality-gate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate --schema=packages/db/prisma/schema.prisma
        env:
          DATABASE_URL: 'postgresql://placeholder:placeholder@placeholder:5432/placeholder?schema=public'

      - name: Type checking
        run: npm run type-check

      - name: Linting
        run: npm run lint

      - name: Code formatting check
        run: npm run format:check

      - name: Unit tests
        run: npm run test

      - name: Build verification
        run: npm run build

      - name: Database schema validation
        run: npx prisma validate --schema=packages/db/prisma/schema.prisma
        env:
          DATABASE_URL: 'postgresql://placeholder:placeholder@placeholder:5432/placeholder?schema=public'

      - name: Validate Prisma migrations
        run: |
          echo "Checking for uncommitted migrations..."
          if [ -n "$(git status --porcelain packages/db/prisma/migrations/)" ]; then
            echo "Error: Uncommitted migration files detected"
            git status packages/db/prisma/migrations/
            exit 1
          fi
          echo "Validating migration files..."
          for migration in packages/db/prisma/migrations/*/migration.sql; do
            if [ -f "$migration" ]; then
              echo "Validating $migration"
              # Basic SQL syntax check (check for common errors)
              if ! grep -q "CREATE\|ALTER\|DROP" "$migration" 2>/dev/null; then
                echo "Warning: $migration may be empty or invalid"
              fi
            fi
          done

      - name: Check migration order
        run: |
          echo "Verifying migration timestamps are in order..."
          migrations=$(ls -1 packages/db/prisma/migrations/ | grep -E '^[0-9]+' | sort)
          prev=""
          for migration in $migrations; do
            if [ -n "$prev" ] && [ "$migration" \< "$prev" ]; then
              echo "Error: Migration $migration comes before $prev (out of order)"
              exit 1
            fi
            prev=$migration
          done
          echo "Migration order is valid"

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            apps/*/.next
            packages/*/dist
          retention-days: 7
          if-no-files-found: ignore

  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run security audit (fail on high/critical)
        run: |
          echo "Running npm audit..."
          audit_output=$(npm audit --audit-level=moderate --json || true)
          if echo "$audit_output" | jq -e '.metadata.vulnerabilities.high > 0 or .metadata.vulnerabilities.critical > 0' > /dev/null 2>&1; then
            echo "❌ High or critical vulnerabilities found!"
            npm audit --audit-level=moderate
            exit 1
          else
            echo "✅ No high or critical vulnerabilities found"
            npm audit --audit-level=moderate || true
          fi

      - name: Check for secrets
        run: npx --yes trufflehog@3 filesystem --fail ./ || true
